# nanobot é¡¹ç›®å­¦ä¹ æŒ‡å—

## é¡¹ç›®æ¦‚è§ˆ

**nanobot** æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§ï¼ˆ~4,000 è¡Œæ ¸å¿ƒä»£ç ï¼‰çš„ä¸ªäºº AI åŠ©æ‰‹æ¡†æ¶ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- ğŸª¶ è¶…è½»é‡ï¼šä»… 4,000 è¡Œæ ¸å¿ƒä»£ç ï¼ˆç›¸æ¯” Clawdbot çš„ 430,000 è¡Œå‡å°‘ 99%ï¼‰
- âš¡ï¸ é«˜æ€§èƒ½ï¼šæœ€å°åŒ–è®¾è®¡æ„å‘³ç€å¿«é€Ÿå¯åŠ¨å’Œä½èµ„æºæ¶ˆè€—
- ğŸ”¬ æ˜“ç ”ç©¶ï¼šä»£ç æ¸…æ™°æ˜“è¯»ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
- ğŸ”Œ å¤šå¹³å°ï¼šæ”¯æŒ Telegramã€Discordã€WhatsAppã€Feishuã€Slack ç­‰å¤šä¸ªèŠå¤©å¹³å°
- ğŸ¤– å¤šæ¨¡å‹ï¼šæ”¯æŒ OpenRouterã€Anthropicã€OpenAIã€DeepSeek ç­‰å¤šä¸ª LLM æä¾›å•†

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å±‚æ¬¡ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·äº¤äº’å±‚                            â”‚
â”‚         (CLI / Telegram / Discord / ...)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¶ˆæ¯è·¯ç”±å±‚                              â”‚
â”‚              MessageBus (æ¶ˆæ¯é˜Ÿåˆ—)                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Inbound Queue  â”‚  Outbound Queue               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ ¸å¿ƒå¤„ç†å±‚                               â”‚
â”‚              AgentLoop (ä»£ç†å¾ªç¯)                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  1. æ¥æ”¶æ¶ˆæ¯                                     â”‚   â”‚
â”‚   â”‚  2. æ„å»ºä¸Šä¸‹æ–‡ (ContextBuilder)                  â”‚   â”‚
â”‚   â”‚  3. è°ƒç”¨ LLM                                     â”‚   â”‚
â”‚   â”‚  4. æ‰§è¡Œå·¥å…· (ToolRegistry)                      â”‚   â”‚
â”‚   â”‚  5. è¿”å›å“åº”                                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ LLM    â”‚  â”‚ Tools  â”‚  â”‚ Memory â”‚
    â”‚ Providerâ”‚  â”‚Registryâ”‚  â”‚ Store  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—å…³ç³»å›¾

```
nanobot/
â”œâ”€â”€ agent/              # ğŸ§  æ ¸å¿ƒä»£ç†é€»è¾‘
â”‚   â”œâ”€â”€ loop.py         #    AgentLoop - ä¸»å¤„ç†å¾ªç¯
â”‚   â”œâ”€â”€ context.py      #    ContextBuilder - æ„å»ºæç¤ºè¯
â”‚   â”œâ”€â”€ memory.py       #    MemoryStore - è®°å¿†å­˜å‚¨
â”‚   â”œâ”€â”€ skills.py       #    SkillsLoader - æŠ€èƒ½åŠ è½½
â”‚   â”œâ”€â”€ subagent.py     #    SubagentManager - å­ä»£ç†ç®¡ç†
â”‚   â””â”€â”€ tools/          #    å·¥å…·é›†åˆ
â”œâ”€â”€ channels/           # ğŸ“± èŠå¤©æ¸ é“é€‚é…å™¨
â”‚   â”œâ”€â”€ telegram.py     #    Telegram é€‚é…å™¨
â”‚   â”œâ”€â”€ discord.py      #    Discord é€‚é…å™¨
â”‚   â”œâ”€â”€ whatsapp.py     #    WhatsApp é€‚é…å™¨
â”‚   â”œâ”€â”€ feishu.py       #    é£ä¹¦é€‚é…å™¨
â”‚   â”œâ”€â”€ slack.py        #    Slack é€‚é…å™¨
â”‚   â””â”€â”€ manager.py      #    æ¸ é“ç®¡ç†å™¨
â”œâ”€â”€ bus/                # ğŸšŒ æ¶ˆæ¯æ€»çº¿
â”‚   â”œâ”€â”€ queue.py        #    MessageBus - æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â””â”€â”€ events.py       #    äº‹ä»¶å®šä¹‰
â”œâ”€â”€ providers/          # ğŸ¤– LLM æä¾›å•†
â”‚   â”œâ”€â”€ registry.py     #    æä¾›å•†æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ litellm_provider.py
â”‚   â”œâ”€â”€ custom_provider.py
â”‚   â””â”€â”€ openai_codex_provider.py
â”œâ”€â”€ session/            # ğŸ’¬ ä¼šè¯ç®¡ç†
â”œâ”€â”€ config/             # âš™ï¸ é…ç½®ç®¡ç†
â”œâ”€â”€ cron/               # â° å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ heartbeat/          # ğŸ’“ å¿ƒè·³æœºåˆ¶
â”œâ”€â”€ skills/             # ğŸ¯ å†…ç½®æŠ€èƒ½
â””â”€â”€ cli/                # ğŸ–¥ï¸ å‘½ä»¤è¡Œæ¥å£
```

---

## ğŸ“Š æ•°æ®æµåˆ†æ

### å®Œæ•´æ¶ˆæ¯å¤„ç†æµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Channel é€‚é…å™¨ â”‚
â”‚ (æ¥æ”¶å¹³å°æ¶ˆæ¯) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¬æ¢ä¸º        â”‚
â”‚ InboundMessageâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageBus   â”‚
â”‚ Inbound Queueâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AgentLoop    â”‚
â”‚ _process_    â”‚
â”‚   message()  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â–¶ Session è·å–/åˆ›å»º
       â”‚
       â”œâ”€â–¶ æ„å»ºä¸Šä¸‹æ–‡ (history + skills + system)
       â”‚
       â”œâ”€â–¶ è°ƒç”¨ LLM
       â”‚
       â”œâ”€â–¶ æ‰§è¡Œå·¥å…·è°ƒç”¨ (å¦‚æœæœ‰)
       â”‚   â”‚
       â”‚   â””â”€â–¶ å¾ªç¯ç›´åˆ°å®Œæˆ
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿å­˜åˆ°        â”‚
â”‚ Session      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¬æ¢ä¸º        â”‚
â”‚ OutboundMsg  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageBus   â”‚
â”‚Outbound Queueâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Channel é€‚é…å™¨ â”‚
â”‚ (å‘é€åˆ°å¹³å°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    ç”¨æˆ·æ”¶åˆ°å›å¤
```

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 1. MessageBusï¼ˆæ¶ˆæ¯æ€»çº¿ï¼‰
**æ–‡ä»¶**: `nanobot/bus/queue.py`

**ä½œç”¨**: è§£è€¦èŠå¤©æ¸ é“å’Œä»£ç†æ ¸å¿ƒ
- **Inbound Queue**: ä»æ¸ é“åˆ°ä»£ç†çš„æ¶ˆæ¯
- **Outbound Queue**: ä»ä»£ç†åˆ°æ¸ é“çš„å“åº”

**å…³é”®æ–¹æ³•**:
- `publish_inbound(msg)` - å‘å¸ƒå…¥ç«™æ¶ˆæ¯
- `consume_inbound()` - æ¶ˆè´¹å…¥ç«™æ¶ˆæ¯
- `publish_outbound(msg)` - å‘å¸ƒå‡ºç«™æ¶ˆæ¯
- `consume_outbound()` - æ¶ˆè´¹å‡ºç«™æ¶ˆæ¯

### 2. AgentLoopï¼ˆä»£ç†å¾ªç¯ï¼‰
**æ–‡ä»¶**: `nanobot/agent/loop.py` (459 è¡Œ)

**æ ¸å¿ƒèŒè´£**:
1. ä» MessageBus æ¶ˆè´¹æ¶ˆæ¯
2. ç®¡ç†ä¼šè¯ (Session)
3. æ„å»ºä¸Šä¸‹æ–‡ (ContextBuilder)
4. è°ƒç”¨ LLM
5. æ‰§è¡Œå·¥å…· (ToolRegistry)
6. è¿”å›å“åº”

**å…³é”®æ–¹æ³•**:
- `run()` - ä¸»å¾ªç¯
- `_process_message()` - å¤„ç†å•æ¡æ¶ˆæ¯
- `_run_agent_loop()` - LLM + å·¥å…·è°ƒç”¨å¾ªç¯

**è¯¦ç»†æ–‡æ¡£**: [agentloop_analysis.md](./agentloop_analysis.md)

### 3. ContextBuilderï¼ˆä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼‰
**æ–‡ä»¶**: `nanobot/agent/context.py` (253 è¡Œ)

**ä½œç”¨**: æ„å»º LLM çš„å®Œæ•´æç¤ºè¯

**ç»„ä»¶**:
- ç³»ç»Ÿæç¤ºè¯
- å†å²å¯¹è¯
- æŠ€èƒ½ (Skills)
- å½“å‰æ¶ˆæ¯

### 4. ToolRegistryï¼ˆå·¥å…·æ³¨å†Œè¡¨ï¼‰
**æ–‡ä»¶**: `nanobot/agent/tools/registry.py`

**å†…ç½®å·¥å…·**:
- `ReadFileTool` - è¯»å–æ–‡ä»¶
- `WriteFileTool` - å†™å…¥æ–‡ä»¶
- `EditFileTool` - ç¼–è¾‘æ–‡ä»¶
- `ExecTool` - æ‰§è¡Œ shell å‘½ä»¤
- `WebSearchTool` - ç½‘é¡µæœç´¢
- `WebFetchTool` - ç½‘é¡µæŠ“å–
- `MessageTool` - å‘é€æ¶ˆæ¯
- `SpawnTool` - å¯åŠ¨å­ä»£ç†
- `CronTool` - å®šæ—¶ä»»åŠ¡
- MCP å·¥å…· - å¤–éƒ¨å·¥å…·é›†æˆ

### 5. Sessionï¼ˆä¼šè¯ç®¡ç†ï¼‰
**æ–‡ä»¶**: `nanobot/session/manager.py`

**ä½œç”¨**: ç®¡ç†å¯¹è¯å†å²å’ŒçŠ¶æ€

**å…³é”®ç‰¹æ€§**:
- æŒä¹…åŒ–å­˜å‚¨
- æ¶ˆæ¯çª—å£ç®¡ç†
- è‡ªåŠ¨å½’æ¡£ (consolidation)

### 6. Memoryï¼ˆè®°å¿†ç³»ç»Ÿï¼‰
**æ–‡ä»¶**: `nanobot/agent/memory.py` (150 è¡Œ)

**ä½œç”¨**: é•¿æœŸè®°å¿†å­˜å‚¨å’Œæ£€ç´¢

### 7. Channelsï¼ˆæ¸ é“é€‚é…å™¨ï¼‰
**ç›®å½•**: `nanobot/channels/`

**æ”¯æŒå¹³å°**:
- Telegram
- Discord
- WhatsApp
- Feishu (é£ä¹¦)
- Slack
- Email
- QQ
- DingTalk (é’‰é’‰)
- Mochat

**ç»Ÿä¸€æ¥å£**:
- æ¯ä¸ªæ¸ é“å®ç° `Channel` åŸºç±»
- å°†å¹³å°ç‰¹å®šæ¶ˆæ¯è½¬æ¢ä¸º `InboundMessage`
- å°† `OutboundMessage` è½¬æ¢ä¸ºå¹³å°ç‰¹å®šæ ¼å¼

### 8. Providersï¼ˆLLM æä¾›å•†ï¼‰
**ç›®å½•**: `nanobot/providers/`

**æ ¸å¿ƒæ–‡ä»¶**:
- `registry.py` - æä¾›å•†æ³¨å†Œè¡¨ï¼ˆå•ä¸€äº‹å®æ¥æºï¼‰
- `base.py` - æä¾›å•†åŸºç±»
- `litellm_provider.py` - LiteLLM æä¾›å•†
- `custom_provider.py` - è‡ªå®šä¹‰æä¾›å•†

**æ”¯æŒçš„æä¾›å•†**:
- OpenRouter (æ¨è)
- Anthropic (Claude)
- OpenAI (GPT)
- DeepSeek
- Groq
- Gemini
- MiniMax
- ç­‰ç­‰...

---

## ğŸ¯ å­¦ä¹ è·¯å¾„å»ºè®®

### é˜¶æ®µ 1: ç†è§£æ¶æ„ï¼ˆå½“å‰é˜¶æ®µï¼‰âœ…

**ç›®æ ‡**: ç†è§£æ•´ä½“æ¶æ„å’Œæ•°æ®æµ

**å·²å®Œæˆ**:
- âœ… æŸ¥çœ‹é¡¹ç›®ç»“æ„
- âœ… ç†è§£æ ¸å¿ƒæ¨¡å—
- âœ… ç†è§£æ•°æ®æµ
- âœ… æ·±å…¥ AgentLoop

**ä¸‹ä¸€æ­¥**: æ·±å…¥å­¦ä¹ å„ä¸ªæ ¸å¿ƒæ¨¡å—

### é˜¶æ®µ 2: æ ¸å¿ƒæ¨¡å—æ·±å…¥

**é¡ºåºå»ºè®®**:
1. âœ… **AgentLoop** (`agent/loop.py`) - ä¸»å¤„ç†é€»è¾‘
2. **ContextBuilder** (`agent/context.py`) - æç¤ºè¯æ„å»º
3. **ToolRegistry** (`agent/tools/`) - å·¥å…·ç³»ç»Ÿ
4. **Sessionç®¡ç†** (`session/manager.py`) - ä¼šè¯ç®¡ç†
5. **Memoryç³»ç»Ÿ** (`agent/memory.py`) - è®°å¿†ç³»ç»Ÿ
6. **Channelé€‚é…å™¨** (`channels/`) - æ¸ é“é›†æˆ
7. **Providerç³»ç»Ÿ** (`providers/`) - LLM é›†æˆ

### é˜¶æ®µ 3: å…³é”®åŠŸèƒ½ç‚¹

**é‡è¦åŠŸèƒ½**:
- å·¥å…·è°ƒç”¨æœºåˆ¶
- ä¼šè¯ç®¡ç†
- è®°å¿†å½’æ¡£ (consolidation)
- å­ä»£ç† (subagent)
- MCP é›†æˆ
- å®šæ—¶ä»»åŠ¡ (cron)
- å¿ƒè·³æœºåˆ¶ (heartbeat)

### é˜¶æ®µ 4: å®è·µå’Œæ‰©å±•

**å»ºè®®ç»ƒä¹ **:
1. æ·»åŠ ä¸€ä¸ªæ–°çš„å·¥å…·
2. æ·»åŠ ä¸€ä¸ªæ–°çš„æ¸ é“
3. æ·»åŠ ä¸€ä¸ªæ–°çš„ LLM æä¾›å•†
4. ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯
5. å®ç°è‡ªå®šä¹‰æŠ€èƒ½

---

## ğŸ“ ä»£ç è´¨é‡ç‰¹ç‚¹

### è®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—èŒè´£æ¸…æ™°
2. **æ¾è€¦åˆ**: é€šè¿‡ MessageBus è§£è€¦
3. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°æ¸ é“ã€æ–°å·¥å…·ã€æ–°æä¾›å•†
4. **å¼‚æ­¥ä¼˜å…ˆ**: å…¨é¢ä½¿ç”¨ asyncio

### ä»£ç é£æ ¼
- ç±»å‹æ³¨è§£ (Type Hints)
- æ¸…æ™°çš„å‡½æ•°å’Œå˜é‡å‘½å
- é€‚åº¦çš„æ³¨é‡Š
- æ¨¡å—åŒ–è®¾è®¡

---

## ğŸ” å…³é”®ä»£ç ç‰‡æ®µç´¢å¼•

### æ¶ˆæ¯å¤„ç†ä¸»å¾ªç¯
**ä½ç½®**: `agent/loop.py:240-269`
```python
async def run(self) -> None:
    """Run the agent loop, processing messages from the bus."""
    while self._running:
        msg = await self.bus.consume_inbound()
        response = await self._process_message(msg)
        if response:
            await self.bus.publish_outbound(response)
```

### LLM + å·¥å…·è°ƒç”¨å¾ªç¯
**ä½ç½®**: `agent/loop.py:174-238`
```python
async def _run_agent_loop(self, initial_messages, on_progress=None):
    while iteration < self.max_iterations:
        response = await self.provider.chat(...)
        if response.has_tool_calls:
            # æ‰§è¡Œå·¥å…·
            result = await self.tools.execute(...)
        else:
            break
    return final_content
```

### å·¥å…·æ‰§è¡Œ
**ä½ç½®**: `agent/tools/registry.py`
- å·¥å…·æ³¨å†Œ
- å·¥å…·æ‰§è¡Œ
- å‚æ•°éªŒè¯

### æ¸ é“é€‚é…å™¨
**ä½ç½®**: `channels/base.py`
- åŸºç±»å®šä¹‰
- æ¶ˆæ¯è½¬æ¢
- ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## ğŸ“š å­¦ä¹ æ–‡æ¡£ç´¢å¼•

| æ¨¡å— | æ–‡æ¡£ | çŠ¶æ€ |
|------|------|------|
| æ•´ä½“æ¶æ„ | [learning_guide.md](./learning_guide.md) | âœ… å·²å®Œæˆ |
| AgentLoop | [agentloop_analysis.md](./agentloop_analysis.md) | âœ… å·²å®Œæˆ |
| ContextBuilder | [context_builder_analysis.md](./context_builder_analysis.md) | âœ… å·²å®Œæˆ |
| ToolRegistry | `tool_registry_analysis.md` | ğŸ“ å¾…åˆ›å»º |
| Sessionç®¡ç† | [session_manager_analysis.md](./session_manager_analysis.md) | âœ… å·²å®Œæˆ |
| ToolRegistry | [tool_registry_analysis.md](./tool_registry_analysis.md) | âœ… å·²å®Œæˆ |
| æ•°æ®æµè¿½è¸ª | [dataflow_analysis.md](./dataflow_analysis.md) | âœ… å·²å®Œæˆ |
| Memoryç³»ç»Ÿ | [memory_system_analysis.md](./memory_system_analysis.md) | âœ… å·²å®Œæˆ |
| Channelé€‚é…å™¨ | `channel_adapter_analysis.md` | ğŸ“ å¾…åˆ›å»º |
| Providerç³»ç»Ÿ | `provider_system_analysis.md` | ğŸ“ å¾…åˆ›å»º |

---

## ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

æ ¹æ®ä½ çš„å­¦ä¹ ç›®æ ‡ï¼Œå¯ä»¥é€‰æ‹©ä»¥ä¸‹è·¯å¾„ï¼š

### è·¯å¾„ A: æŒ‰æ¨¡å—æ·±å…¥å­¦ä¹ ï¼ˆæ¨èï¼‰
1. ContextBuilder - ç†è§£å¦‚ä½•æ„å»º LLM æç¤ºè¯
2. ToolRegistry - å­¦ä¹ å·¥å…·ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°
3. Sessionç®¡ç† - æŒæ¡ä¼šè¯æŒä¹…åŒ–æœºåˆ¶
4. Memoryç³»ç»Ÿ - ç†è§£é•¿æœŸè®°å¿†å’Œå½’æ¡£

### è·¯å¾„ B: è·Ÿè¸ªæ•°æ®æµ
1. ä»ç”¨æˆ·è¾“å…¥åˆ° LLM å“åº”çš„å®Œæ•´æµç¨‹
2. å·¥å…·è°ƒç”¨çš„è¯¦ç»†æœºåˆ¶
3. ä¼šè¯çŠ¶æ€ç®¡ç†

### è·¯å¾„ C: å®è·µå¯¼å‘
1. æ·»åŠ è‡ªå®šä¹‰å·¥å…·
2. é›†æˆæ–°çš„èŠå¤©å¹³å°
3. å®ç°æ–°çš„ LLM æä¾›å•†

---

**ä½ æƒ³ä»å“ªä¸ªæ¨¡å—ç»§ç»­å­¦ä¹ ï¼Ÿ**
